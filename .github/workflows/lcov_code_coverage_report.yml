name: lcov-code-coverage-report
run-name: ${{ github.actor }} is running lcov-code-coverage-report ðŸš€

on:
  push:
    branches:
      # - main
      # - '**'
      - xxx
  pull_request:
    branches:
      - main

env:
  CMAKE_VERSION: 3.21.4
  BUILD_DIR: ${{ github.workspace }}/build
  BUILD_TYPE: Debug

# permissions:
#   pull-requests: write  

jobs:
  generate-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Print GitHub context
        run: |
          echo "GitHub Event: ${{ github.event_name }}"
          echo "Runner OS: ${{ runner.os }}"
          echo "GitHub Ref: ${{ github.ref }}"
          echo "GitHub Repository: ${{ github.repository }}"
          echo "Workspace: ${{ github.workspace }}"

      - name: Set up dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y g++ lcov

      - name: Set up CMake
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: ${{ env.CMAKE_VERSION }}        
      
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Configure CMake
        run: cmake -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DENABLE_TESTING=ON -DENABLE_COVERAGE=ON -B ${{ env.BUILD_DIR }} -S .

      - name: Build with CMake
        run: cmake --build ${{ env.BUILD_DIR }} --config ${{ env.BUILD_TYPE }} --target coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v2
        with:
          name: coverage-info
          path: ${{ env.BUILD_DIR }}/coverage.info
      
      - name: Upload coverage html report
        uses: actions/upload-artifact@v2
        with:
          name: coverage-html
          path: ${{ env.BUILD_DIR }}/coverage_html

  generate-report:
    runs-on: ubuntu-latest
    needs: generate-coverage

    steps:
      - name: ls -l
        run: ls -l

      - name: Download coverage info
        uses: actions/download-artifact@v2
        with:
          name: coverage-info

      - name: Download coverage report
        uses: actions/download-artifact@v2
        with:
          name: coverage-html
          path: coverage_html        

      - name: ls
        run: ls -l

      - name: cat coverage.info
        run: cat coverage.info

      - name: LCOV Reporter
        uses: romeovs/lcov-reporter-action@v0.2.16
        with:
          lcov-file: ./coverage.info

      # - name: LCOV Reporter
      #   uses: romeovs/lcov-reporter-action@v0.3.1
      #   with:
      #     lcov-file: coverage.info
      #     github-token: ${{ secrets.CODE_COVERAGE_TOKEN }}

      # - name: Code Coverage Summary Report
      #   uses: irongut/CodeCoverageSummary@v1.3.0
      #   with:
      #     filename: coverage.info

      # - name: Post coverage comment
      #   uses: marocchino/sticky-pull-request-comment@v2
      #   with:
      #     message: |
      #       ## Code Coverage Report
      #       ```
      #       $(lcov --summary coverage.info)
      #       ```
      #       [View detailed report](./coverage_html/index.html)
      #     github_token: ${{ secrets.GITHUB_TOKEN }}

      # - name: Deploy coverage report to GitHub Pages
      #   if: github.event_name == 'push'
      #   uses: peaceiris/actions-gh-pages@v3
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: ./coverage_html    